name: Publish to PyPI

on:
  push:
    tags:
      - "*"

permissions:
  contents: read

jobs:
  pypi-publish:
    name: Upload release to PyPI
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/langmem0
    permissions:
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          python-version: 3.13

      - name: Validate tag format
        uses: matt-usurp/validate-semver@v2
        with:
          version_string: ${{ github.ref_name }}

      - name: Verify tag matches pyproject.toml version
        run: |
          tag="${{ github.ref_name }}"
          # Remove 'v' prefix if present
          tag_version="${tag#v}"
          project_version=$(grep -Po '(?<=^version = ")[^"]*' pyproject.toml)
          if [ "$tag_version" != "$project_version" ]; then
            echo "Error: Tag version ($tag_version) does not match pyproject.toml ($project_version)"
            exit 1
          fi
          echo "Version matches: $tag_version"

      - name: Verify tag is on main branch
        run: |
          git fetch origin main
          if ! git branch --contains "${{ github.ref }}" --remotes | grep -q "origin/main"; then
            echo "Error: Tag ${{ github.ref_name }} is not on main branch"
            exit 1
          fi

      - name: Build
        run: uv build

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
