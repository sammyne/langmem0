name: Sync to GitCode

on:
  # 在推送到 main 或 dev 分支时触发
  push:
    branches:
      - main
      - dev
  # 允许手动触发
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 获取完整的 git 历史记录
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "sammyne"
          git config --global user.email "xiangmin-li@qq.com"

      - name: Setup SSH for GitCode
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.GITCODE_SSH_PRIVATE_KEY }}" > ~/.ssh/gitcode_key
          chmod 600 ~/.ssh/gitcode_key
          ssh-keyscan -H gitcode.com >> ~/.ssh/known_hosts

      - name: Verify SSH connection to GitCode
        run: |
          echo "Testing SSH connection to gitcode.com..."
          ssh -i ~/.ssh/gitcode_key -T git@gitcode.com || echo "SSH connection test completed"

      - name: Add GitCode remote
        run: |
          git remote add gitcode git@gitcode.com:sammyne/langmem0.git

      - name: Sync main branch to gitcode/github
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Syncing main branch to gitcode/github"
          git push gitcode main:github -f --no-verify

      - name: Sync dev branch to gitcode/github-dev
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "Syncing dev branch to gitcode/github-dev"
          git push gitcode dev:github-dev -f --no-verify

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/gitcode_key
